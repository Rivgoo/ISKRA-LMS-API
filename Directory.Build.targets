<Project>

  <!-- This target runs only if the project defines <IsIskraModule>true</IsIskraModule> -->
  <Target Name="CopyModuleToHost" AfterTargets="Build" Condition="'$(IsIskraModule)' == 'true'">
    
    <PropertyGroup>
      <!-- Calculates the path to the Host's Modules folder. 
           Adjust 'src\Iskra.Api.Host' if your folder name is different. -->
      <HostModulesDir>$(MSBuildThisFileDirectory)src\Api\Iskra.Api.Host\bin\$(Configuration)\$(TargetFramework)\Modules\</HostModulesDir>
    </PropertyGroup>

    <ItemGroup>
      <!-- 1. All DLLs generated by the module (including dependencies like Pomelo, Npgsql) -->
      <ModuleFiles Include="$(OutputPath)*.dll" />
      
      <!-- 2. The PDB symbols (for debugging) -->
      <ModuleFiles Include="$(OutputPath)*.pdb" />

      <!-- 3. Configuration Files (e.g., Iskra.Infrastructure.MariaDb.json) 
           We look for ANY .json file in the project root, excluding obj/bin folders -->
      <ConfigFiles Include="$(ProjectDir)*.json" Exclude="$(ProjectDir)bin\**;$(ProjectDir)obj\**;$(ProjectDir)appsettings*.json" />
    </ItemGroup>

    <!-- Ensure the directory exists -->
    <MakeDir Directories="$(HostModulesDir)" />

    <!-- Execute Copy -->
    <Copy SourceFiles="@(ModuleFiles)" DestinationFolder="$(HostModulesDir)" SkipUnchangedFiles="true" />
    <Copy SourceFiles="@(ConfigFiles)" DestinationFolder="$(HostModulesDir)" SkipUnchangedFiles="true" />

    <!-- Log to Build Output -->
    <Message Text="[Iskra Build] Deployed module '$(AssemblyName)' to $(HostModulesDir)" Importance="High" />
  </Target>

</Project>